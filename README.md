# 集团员工内部用餐点餐平台

## 项目简介

集团员工内部用餐点餐平台是一个为企业集团开发的员工用餐管理系统，支持多食堂管理、在线点餐、菜单管理、订单管理等功能。系统分为员工端（H5移动端）和管理端（PC端）两个部分，为员工提供便捷的点餐服务，为管理人员提供高效的管理工具。

## 功能特性

### 员工端功能
- **选择食堂**: 员工可以选择不同办公地点的食堂进行点餐
- **点餐日历**: 查看未来几天可预订的餐次，方便提前规划
- **即时点餐**: 在规定时间内为当天餐次点餐（早餐7:30前，午餐11:00前，晚餐17:00前）
- **预订餐次**: 支持预订明天或之后的餐次
- **查看菜单**: 查看选定食堂当日/未来日期的菜单和菜品
- **订单管理**: 查看订单历史、订单详情、订单状态
- **取消订单**: 在截止时间前可以取消订单

### 管理端功能
- **食堂管理**: 新增、编辑、删除食堂信息
- **菜品管理**: 管理食堂菜品，支持上下架功能
- **菜单管理**: 配置每日各餐次的菜单和菜品数量
- **订单管理**: 查看和管理订单，按餐次、日期筛选
- **餐次统计**: 按菜品和员工统计订单数据，辅助备餐

### 系统特性
- **三种角色**: 员工、食堂人员、系统管理员
- **多食堂支持**: 支持企业多个办公地点的食堂管理
- **时间限制**: 自动检查点餐时间限制，防止超时下单
- **库存管理**: 实时扣减和退回菜品库存
- **无支付流程**: 企业内部免费用餐，简化流程

## 技术架构

### 后端技术栈
- **语言**: Python 3.12
- **框架**: Flask 3.0.0
- **数据库**: SQLite（使用原生SQL，不使用ORM）
- **环境**: Conda虚拟环境 (ordering-system)

### 前端技术栈
- **管理端**: HTML + CSS + JavaScript（原生）
- **员工端**: HTML + CSS + JavaScript（原生，H5移动端适配）

### 系统架构
```
┌─────────────────────────────────────────────┐
│              集团员工点餐平台                  │
├─────────────────────────────────────────────┤
│                                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 员工端   │  │ 管理端   │  │ API服务  │  │
│  │ (8081)   │  │ (8080)   │  │ (8082)   │  │
│  │ H5页面   │  │ PC页面   │  │ Flask    │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  │
│       │             │             │         │
│       └─────────────┴─────────────┘         │
│                     │                       │
│              ┌──────┴──────┐                │
│              │   SQLite    │                │
│              │  数据库     │                │
│              └─────────────┘                │
└─────────────────────────────────────────────┘
```

## 环境要求

### 必需软件
- Python 3.12
- Conda (Anaconda 或 Miniconda)

### 浏览器支持
- **管理端**: Chrome、Firefox、Edge 最新版本
- **员工端**: iOS Safari、Android Chrome、微信内置浏览器

## 安装部署

### 1. 创建Conda环境

```bash
# 进入项目目录
cd /path/to/kaa-demo

# 使用environment.yml创建环境
conda env create -f environment.yml

# 激活环境
conda activate ordering-system
```

### 2. 初始化数据库

```bash
# 方式1: 使用Python脚本初始化
cd api
python init_db.py

# 方式2: 使用SQL脚本手动初始化
sqlite3 data/ordering_system.db < init-db.sql
```

### 3. 启动服务

```bash
# 使用一键启动脚本
./quick-start.sh
```

脚本会自动启动以下服务：
- API服务: http://localhost:8082
- 管理端: http://localhost:8080
- 员工端: http://localhost:8081

### 4. 停止服务

```bash
# 使用一键停止脚本
./quick-stop.sh
```

## 使用说明

### 测试账号

#### 管理员账号
- 工号: `ADMIN001`
- 密码: `admin123`
- 权限: 所有功能

#### 食堂人员账号
- 工号: `STAFF001`
- 密码: `staff123`
- 权限: 菜品管理、菜单管理、订单查看、统计查看

#### 员工账号
- 工号: `EMP001` - `EMP010`
- 密码: `user123`
- 权限: 点餐、查看订单、取消订单

### 管理端使用流程

1. **登录系统**
   - 访问 http://localhost:8080
   - 使用管理员或食堂人员账号登录

2. **食堂管理**
   - 点击"食堂管理"查看所有食堂
   - 可以新增、编辑食堂信息

3. **菜品管理**
   - 点击"菜品管理"
   - 选择食堂筛选菜品
   - 可以新增菜品、上下架菜品

4. **菜单管理**
   - 点击"菜单管理"
   - 创建每日菜单，选择日期、餐次
   - 为菜单添加菜品和数量

5. **订单管理**
   - 点击"订单管理"
   - 选择食堂、日期、餐次查看订单
   - 可以查看订单详情

6. **餐次统计**
   - 点击"餐次统计"
   - 选择食堂、日期、餐次
   - 查看按菜品和员工的统计数据

### 员工端使用流程

1. **登录系统**
   - 访问 http://localhost:8081（建议用手机或浏览器移动模式）
   - 使用员工账号登录

2. **选择食堂点餐**
   - 在首页点击食堂卡片
   - 或点击底部"点餐"按钮

3. **查看菜单下单**
   - 选择日期和餐次
   - 点击"查看菜单"
   - 使用 + / - 按钮选择菜品数量
   - 点击"确认下单"

4. **查看订单**
   - 点击底部"订单"按钮
   - 查看所有订单历史
   - 可以按状态筛选订单

5. **取消订单**
   - 在订单列表中找到要取消的订单
   - 点击"取消订单"按钮
   - 确认取消（仅限截止时间前）

## 目录结构

```
kaa-demo/
├── api/                        # 后端API服务
│   ├── app.py                 # Flask应用主程序
│   ├── config.py              # 配置文件
│   ├── init_db.py             # 数据库初始化脚本
│   ├── services/              # 业务逻辑层
│   │   ├── auth_service.py    # 认证服务
│   │   ├── canteen_service.py # 食堂服务
│   │   ├── dish_service.py    # 菜品服务
│   │   ├── menu_service.py    # 菜单服务
│   │   └── order_service.py   # 订单服务
│   └── utils/                 # 工具函数
│       └── helpers.py         # 辅助函数
├── admin-web/                 # 管理端前端
│   ├── index.html            # 管理端首页
│   ├── css/
│   │   └── style.css         # 管理端样式
│   └── js/
│       └── app.js            # 管理端脚本
├── user-web/                  # 员工端前端
│   ├── index.html            # 员工端首页
│   ├── css/
│   │   └── style.css         # 员工端样式
│   └── js/
│       └── app.js            # 员工端脚本
├── data/                      # 数据目录
│   └── ordering_system.db    # SQLite数据库
├── logs/                      # 日志目录
│   ├── api.log               # API日志
│   ├── admin-web.log         # 管理端日志
│   └── user-web.log          # 员工端日志
├── pids/                      # 进程ID目录
├── init-db.sql               # 数据库初始化SQL脚本
├── environment.yml           # Conda环境配置
├── quick-start.sh            # 一键启动脚本
├── quick-stop.sh             # 一键停止脚本
├── README.md                 # 项目文档
├── EARS_需求文档.md           # EARS需求文档
├── INCOSE_质量规范需求文档.md # INCOSE质量规范文档
├── Steering_Spec.md          # 项目规范文档
└── 功能需求.csv              # 原始功能需求
```

## API文档

### 认证接口

#### 用户登录
- **接口**: `POST /api/auth/login`
- **请求体**:
  ```json
  {
    "employee_id": "EMP001",
    "password": "user123"
  }
  ```
- **响应**:
  ```json
  {
    "code": 0,
    "message": "success",
    "data": {
      "id": 1,
      "employee_id": "EMP001",
      "full_name": "张三",
      "role": "employee"
    }
  }
  ```

### 食堂接口

#### 获取食堂列表
- **接口**: `GET /api/canteens`
- **参数**: `status` (可选): active/inactive
- **响应**: 食堂列表

#### 获取食堂详情
- **接口**: `GET /api/canteens/{id}`
- **响应**: 食堂详细信息

### 菜品接口

#### 获取菜品列表
- **接口**: `GET /api/dishes`
- **参数**:
  - `canteen_id` (可选): 食堂ID
  - `category_id` (可选): 分类ID
  - `status` (可选): active/inactive
- **响应**: 菜品列表

#### 获取菜品分类
- **接口**: `GET /api/dish-categories`
- **响应**: 分类列表

### 菜单接口

#### 获取菜单列表
- **接口**: `GET /api/menus`
- **参数**:
  - `canteen_id` (可选): 食堂ID
  - `menu_date` (可选): 日期 (YYYY-MM-DD)
  - `meal_type` (可选): breakfast/lunch/dinner
- **响应**: 菜单列表

#### 获取菜单详情
- **接口**: `GET /api/menus/{id}`
- **响应**: 菜单详情（包含菜品列表）

### 订单接口

#### 创建订单
- **接口**: `POST /api/orders`
- **请求头**: `X-User-Id: {用户ID}`
- **请求体**:
  ```json
  {
    "canteen_id": 1,
    "menu_id": 1,
    "meal_type": "lunch",
    "order_date": "2025-01-15",
    "items": [
      {"dish_id": 1, "quantity": 2},
      {"dish_id": 3, "quantity": 1}
    ]
  }
  ```
- **响应**: 订单ID

#### 获取我的订单
- **接口**: `GET /api/orders/my`
- **请求头**: `X-User-Id: {用户ID}`
- **参数**: `status` (可选): placed/cancelled/completed
- **响应**: 订单列表

#### 取消订单
- **接口**: `POST /api/orders/{id}/cancel`
- **请求头**: `X-User-Id: {用户ID}`
- **响应**: 成功/失败

#### 获取餐次统计
- **接口**: `GET /api/statistics/meal`
- **请求头**: `X-User-Id: {用户ID}`
- **参数**:
  - `canteen_id`: 食堂ID
  - `order_date`: 日期
  - `meal_type`: 餐次类型
- **响应**: 统计数据

### 响应格式

所有API响应遵循统一格式：

**成功响应**:
```json
{
  "code": 0,
  "message": "success",
  "data": { /* 响应数据 */ }
}
```

**错误响应**:
```json
{
  "code": 1001,
  "message": "错误信息",
  "data": null
}
```

### 错误码

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 1000 | 系统错误 |
| 1001 | 数据库错误 |
| 1002 | 参数错误 |
| 2001 | 超过时间限制 |
| 2002 | 重复订单 |
| 2003 | 库存不足 |
| 2004 | 订单不存在 |
| 3001 | 未授权 |
| 3002 | 无权限 |
| 3003 | 用户不存在 |
| 3004 | 密码错误 |

## 数据库设计

### 主要数据表

1. **departments** - 部门表
   - 支持组织架构管理

2. **canteens** - 食堂表
   - 存储食堂基本信息

3. **users** - 用户表
   - 存储所有用户（员工、食堂人员、管理员）
   - 预留企业微信集成字段

4. **canteen_staff_relations** - 食堂人员关联表
   - 关联食堂人员与食堂

5. **dish_categories** - 菜品分类表
   - 菜品分类管理

6. **dishes** - 菜品表
   - 存储菜品信息

7. **menus** - 菜单表
   - 每日菜单配置

8. **menu_items** - 菜单项表
   - 菜单中的菜品和数量

9. **orders** - 订单表
   - 订单主表

10. **order_items** - 订单项表
    - 订单明细

11. **dish_ratings** - 菜品评分表（预留）
    - 菜品评价功能

12. **feedbacks** - 意见反馈表（预留）
    - 员工反馈功能

## 业务规则

### 时间限制规则
- **早餐**: 当天 07:30 前可点
- **午餐**: 当天 11:00 前可点
- **晚餐**: 当天 17:00 前可点
- **预订**: 只能预订明天或之后的餐次

### 订单规则
- 每个员工每个餐次只能有一个有效订单
- 订单状态: 已下单 → 已取消 或 已完成
- 只能在截止时间前取消订单
- 取消订单后库存自动退回

### 库存规则
- 下单时立即扣减库存
- 取消订单时退回库存
- 库存为0时标记为"已售罄"

## 常见问题

### 1. 如何重置数据库？

```bash
# 删除旧数据库
rm data/ordering_system.db

# 重新初始化
cd api
python init_db.py
```

### 2. 如何查看服务日志？

```bash
# 查看API日志
tail -f logs/api.log

# 查看管理端日志
tail -f logs/admin-web.log

# 查看员工端日志
tail -f logs/user-web.log
```

### 3. 如何修改端口？

编辑 `api/config.py` 文件：
```python
API_PORT = 8082  # 修改为其他端口
```

修改启动脚本中的前端端口：
```bash
python -m http.server 8080  # 修改为其他端口
```

### 4. 员工端在手机上如何访问？

确保手机和电脑在同一局域网，然后：
1. 获取电脑IP地址（如：192.168.1.100）
2. 在手机浏览器访问：`http://192.168.1.100:8081`

### 5. 如何添加测试数据？

可以直接操作数据库：
```bash
sqlite3 data/ordering_system.db

# 添加食堂
INSERT INTO canteens (name, address, phone, status, created_at, updated_at)
VALUES ('新食堂', '地址', '电话', 'active', datetime('now'), datetime('now'));

# 添加菜品
INSERT INTO dishes (name, category_id, canteen_id, status, created_at, updated_at)
VALUES ('新菜品', 1, 1, 'active', datetime('now'), datetime('now'));
```

## 开发规范

### 代码规范
- **代码标识符**: 必须使用英文（变量、函数、类名等）
- **注释和文档**: 必须使用中文
- **命名风格**: 遵循PEP 8规范
  - 类名: PascalCase
  - 函数名: snake_case
  - 常量名: UPPER_SNAKE_CASE

### 安全规范
- 所有SQL查询使用参数化查询，防止SQL注入
- 密码使用SHA256加密存储
- API接口需要用户认证
- 基于角色的权限控制

## 扩展功能（预留）

以下功能已预留字段和接口，但本期未实现：

1. **企业微信集成**
   - 数据库已预留 `wechat_openid`、`wechat_userid` 字段
   - 可集成企业微信登录

2. **菜品评分**
   - `dish_ratings` 表已创建
   - 可实现员工对菜品评分功能

3. **意见反馈**
   - `feedbacks` 表已创建
   - 可实现员工意见反馈功能

4. **取餐核销**
   - 可添加核销码和扫码取餐功能

5. **订单修改**
   - OrderService已实现修改订单功能
   - 可在前端添加修改入口

## 技术支持

如有问题或建议，请联系技术支持团队。

## 许可证

本项目为企业内部使用项目，未开源。

---

**版本**: 1.0.0  
**更新日期**: 2025-01-01  
**开发团队**: 技术中心
